<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>About problems of cache invalidation. Cache tagging. &mdash; @emacsway&#39;s blog</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/jquery-toast-plugin/jquery.toast.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/fa/css/all.min.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/jquery-toast-plugin/jquery.toast.min.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="@emacsway&#39;s blog" href="../../" />
  

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />


    

        <meta http-equiv="Last-Modified" content="Thu, 10 Nov 2016 00:00:00 GMT" />
        
            <meta name="description" content="About my experience of solving problems of cache invalidation and principles of the library cache-dependencies." />
        
        
            <meta property="og:image" content="../../_static/logo.jpg" />
            <link rel="image_src" href="../../_static/logo.jpg" />
        

        <link rel="canonical" href="https://emacsway.github.io/en/cache-dependencies/" />

        <script type="text/javascript">
            setTimeout(function() {
                $.toast({
                    text: 'If you like this site, please support it with an external link or share it with an social nerwork. <br />Subscribe to my <a class="reference external" href="https://t.me/emacsway_log"><i class="fab fa-telegram"></i> Telegram-channel</a>. Thanks!',
                    position: 'bottom-right',
                    hideAfter: 12000
                });
            }, 30000);
        </script>

    


  
  <link rel="alternate" type="application/atom+xml"  href="../../blog/atom.xml" title="@emacsway's blog">
  
  
  <link href="True" rel="stylesheet">
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="about-problems-of-cache-invalidation-cache-tagging">
<h1><a class="toc-backref" href="#id2">About problems of cache invalidation. Cache tagging.</a><a class="headerlink" href="#about-problems-of-cache-invalidation-cache-tagging" title="Permalink to this headline">¶</a></h1>
<p>About my experience of solving problems of cache invalidation and principles of the library <a class="reference external" href="https://bitbucket.org/emacsway/cache-dependencies">cache-dependencies</a>.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#about-problems-of-cache-invalidation-cache-tagging" id="id2">About problems of cache invalidation. Cache tagging.</a></li>
<li><a class="reference internal" href="#the-problem-of-cache-dependencies" id="id3">The problem of cache dependencies</a></li>
<li><a class="reference internal" href="#overhead-of-cache-reading-vs-overhead-of-cache-creation" id="id4">Overhead of cache reading vs overhead of cache creation</a></li>
<li><a class="reference internal" href="#tagging-of-nested-caches" id="id5">Tagging of nested caches</a></li>
<li><a class="reference internal" href="#replication-problem" id="id6">Replication problem</a></li>
<li><a class="reference internal" href="#implementation-of-tag-locking" id="id7">Implementation of tag locking</a><ul>
<li><a class="reference internal" href="#constructive-obstacle-to-implementing-pessimistic-locking" id="id8">Constructive obstacle to implementing pessimistic locking</a></li>
<li><a class="reference internal" href="#accompanying-obstacle-to-implementing-pessimistic-locking" id="id9">Accompanying obstacle to implementing pessimistic locking</a></li>
</ul>
</li>
<li><a class="reference internal" href="#thundering-herd" id="id10">Thundering herd</a></li>
<li><a class="reference internal" href="#transaction-problem" id="id11">Transaction problem</a><ul>
<li><a class="reference internal" href="#read-uncommitted" id="id12">Read uncommitted</a></li>
<li><a class="reference internal" href="#read-committed" id="id13">Read committed</a></li>
<li><a class="reference internal" href="#repeatable-read" id="id14">Repeatable read</a></li>
<li><a class="reference internal" href="#serializable" id="id15">Serializable</a></li>
</ul>
</li>
<li><a class="reference internal" href="#multiple-connections-to-database" id="id16">Multiple connections to Database</a></li>
<li><a class="reference internal" href="#non-cached-fragment-dynamic-window-in-cache" id="id17">Non-cached fragment. Dynamic window in cache.</a></li>
<li><a class="reference internal" href="#abstract-dependency-manager" id="id18">Abstract dependency manager</a></li>
<li><a class="reference internal" href="#gratitude" id="id19">Gratitude</a></li>
</ul>
</div>
</div>
<div class="section" id="the-problem-of-cache-dependencies">
<h1><a class="toc-backref" href="#id3">The problem of cache dependencies</a><a class="headerlink" href="#the-problem-of-cache-dependencies" title="Permalink to this headline">¶</a></h1>
<p>When some data has been updated, all dependent caches should be reset.
Suppose, the cache of main page of a company site contains an instance of Product model.
When the instance of Product is updated, the cache should be updated too.
Another example, when an attribute of User model (for example, last_name) has been updated, all caches of the user&#8217;s posts containing the last_name should be reset too.</p>
<p>Usually, the pattern <a class="reference external" href="https://en.wikipedia.org/wiki/Observer_pattern">Observer</a> (or its variety pattern Multicast) is responsible for the cache invalidation.
But even in this case the invalidation logic becomes too complicated, the achieved accuracy is too low, the <a class="reference external" href="http://wiki.c2.com/?CouplingAndCohesion">Coupling</a> is growing fast, and encapsulation is disclosed.</p>
<p>The solution of the issue can be cache tagging (i.e. marking cache by tags).
For example, the cache of main page can be marked by tag <code class="docutils literal"><span class="pre">product.id:635</span></code>.
The all user&#8217;s posts can be marked by tag <code class="docutils literal"><span class="pre">user.id:10</span></code>.
Post lists can be marked by composite tag, composed of selection criteria, for example <code class="docutils literal"><span class="pre">type.id:1;category.id:15;region.id:239</span></code>.</p>
<p>Now it&#8217;s enough to invalidate the tag to invalidate all dependent caches.
This approach is not new, and widely used for other programming languages.
At one time it was even implemented for memcache, see <a class="reference external" href="http://code.google.com/p/memcached-tag/">memcached-tag</a>.</p>
<p>See also:</p>
<ul class="simple">
<li><a class="reference external" href="https://pypi.python.org/pypi/wheezy.caching">Cache dependency in wheezy.caching</a></li>
<li><a class="reference external" href="http://framework.zend.com/manual/current/en/modules/zend.cache.storage.adapter.html#the-taggableinterface">TaggableInterface of ZF</a></li>
<li><a class="reference external" href="http://www.yiiframework.com/doc-2.0/yii-caching-tagdependency.html">TagDependency of YII framework</a></li>
<li><a class="reference external" href="http://dklab.ru/lib/Dklab_Cache/">Dklab_Cache: правильное кэширование — тэги в memcached, namespaces, статистика</a></li>
</ul>
</div>
<div class="section" id="overhead-of-cache-reading-vs-overhead-of-cache-creation">
<h1><a class="toc-backref" href="#id4">Overhead of cache reading vs overhead of cache creation</a><a class="headerlink" href="#overhead-of-cache-reading-vs-overhead-of-cache-creation" title="Permalink to this headline">¶</a></h1>
<p>How to implement invalidation of caches dependent on the tag?
There are two ways:</p>
<p>1. To destroy physically all dependent caches on the tag invalidation.
Implementation of this approach requires some overhead on the cache creation to add key of the cache into a cache list (or set) of the tag (for example, using <a class="reference external" href="http://redis.io/commands/sadd">SADD</a>).
The disadvantage of this approach is that the invalidation of too many dependent caches takes some time.</p>
<p>2. To just change the version of the tag on invalidation it.
Implementation of this approach requires some overhead on reading the cache to verify the version of each tag of the cache with the actual tag version.
Thus the cache should contain all tag versions on the cache creation.
If any tag has expired version on the cache reading, the cache is invalid.
The advantage of this approach is immediate invalidation of the tag and all dependent caches.
Another advantage of this approach is that premature discarding of a tag info is not possible (using <a class="reference external" href="https://en.wikipedia.org/wiki/Cache_replacement_policies#LRU">LRU</a>), because the tag info has been read mush often than dependent caches.</p>
<p>I&#8217;ve chosen the second option.</p>
</div>
<div class="section" id="tagging-of-nested-caches">
<h1><a class="toc-backref" href="#id5">Tagging of nested caches</a><a class="headerlink" href="#tagging-of-nested-caches" title="Permalink to this headline">¶</a></h1>
<p>Because tags are being verified at the moment of cache reading, let&#8217;s imagine, what happens, when one cache would be nested to other cache.
Multi-level cache is not so rarely.
In this case, the tags of inner cache would be never verified, and outer cache would be alive with outdated data.
At the moment of creation the outer cache it must accept the all tags from the inner cache into own tag list.
If we passed the tags from the inner cache to the outer cache in an explicit way, it would violate encapsulation!
So, the cache system must keep track the relations between all nested caches, and pass automatically all tags from an inner cache to its outer cache.</p>
</div>
<div class="section" id="replication-problem">
<h1><a class="toc-backref" href="#id6">Replication problem</a><a class="headerlink" href="#replication-problem" title="Permalink to this headline">¶</a></h1>
<p>When tag has been invalidated, a concurrent thread/process can recreate the dependent cache with outdated data from the slave, before the slave will be updated.</p>
<p>The best solution of this problem is a <a class="reference internal" href="#tags-lock-en"><span class="std std-ref">locking the tag</span></a> for cache creation until slave will be updated.
But, first, this implies a certain overhead, and secondly, all threads (including current one) continue to read outdated data from the slave (unless the master is specified explicitly for reading).</p>
<p>A compromise solution can be simple re-invalidation of the tag after period of time when the slave is guaranteed to be updated.</p>
<p>I saw also the approach of cache regeneration instead of removing/invalidation.
This approach entail ineffective memory usage on condition of using the <a class="reference external" href="https://en.wikipedia.org/wiki/Cache_replacement_policies#LRU">LRU</a> principle.
Also, this approach does not resolve the problem of complexity of invalidation logic.
Usually, this approach is the cause of a lot of bugs.
For example, it requires to use a high quality ORM.
Some ORMs does not perform type conversion of instance attributes on save, therefore, the cache can be wrong (for example, there can be a string instead of a datetime instance).
I saw such case in my practice, the cache saved the string from the HTTP-client instead of the datatime instance. Although the data had been saved correctly, the model logic didn&#8217;t performed type conversion until some another method had been called (semantic coupling).</p>
<div class="note update admonition">
<p class="first admonition-title">Updated on Nov 10, 2016</p>
<p class="last">Added description of implementation of tag locking.</p>
</div>
</div>
<div class="section" id="implementation-of-tag-locking">
<span id="tags-lock-en"></span><h1><a class="toc-backref" href="#id7">Implementation of tag locking</a><a class="headerlink" href="#implementation-of-tag-locking" title="Permalink to this headline">¶</a></h1>
<p>The main purpose of tag locking is to prevent the substitution of actual data by outdated data of concurrent threads/processes, if it&#8217;s needed by transaction isolation level or delay of replication.</p>
<p>The tag locking is implemented by the library in the form of preventing the creation of dependent cache by the concurent threads/processes while the tag is locked.</p>
<p>Why <a class="reference external" href="http://martinfowler.com/eaaCatalog/pessimisticOfflineLock.html">Pessimistic Offline Lock</a> or <a class="reference external" href="https://en.wikipedia.org/wiki/Mutual_exclusion">Mutual Exclusion</a>  had not been implemented?
This is <a class="reference internal" href="#thundering-herd-en"><span class="std std-ref">resonable</span></a> question, because the cached logic can be too resource intensive.
This way of implementation requires concurent threads/processes are waiting untile the locked tag will be released.</p>
<div class="section" id="constructive-obstacle-to-implementing-pessimistic-locking">
<h2><a class="toc-backref" href="#id8">Constructive obstacle to implementing pessimistic locking</a><a class="headerlink" href="#constructive-obstacle-to-implementing-pessimistic-locking" title="Permalink to this headline">¶</a></h2>
<p>The main purpose of the library is cache invalidation.</p>
<p>Suppose, the process P1 has begun transaction with isolation level of &#8220;Repeatable read&#8221;.</p>
<p>Then the process P2 has begun the transaction, updated data in the DB, invalidated tag T1, and ascuired the lock for the tag T1 until the transaction will be committed.</p>
<p>Process P1 are trying to read the cache with key C1, which is tagged by the tag T1 and is not valid anymore.
Not being able to read the invalid cache C1, the process P1 receives the outdated data from the DB (remember, the transaction isolation level is &#8220;Repeatable read&#8221;).
Then the process P1 are trying to create the cache C1, and waiting while the tag T1 will be released.</p>
<p>When the transaction of process P2 is committed, the process P2 releases the tag T1.
Then the process P1 writes the outdated data into the cache C1.
This locking does not make any sense.</p>
<p>But what happens, if we check the status of tag T1 on the cache reading (not writing)?
Could this approach to change something?</p>
<p>Yes, it can.
At first, it would add the overhead to reading logic.
Secondly, it could have the effect on condition transaction isolation level is not higher than &#8220;Read committed&#8221;.
For the transaction isolation level &#8220;Repeatable read&#8221; (which is default for some DB and at least is required by correct work of pattern <a class="reference external" href="http://martinfowler.com/eaaCatalog/identityMap.html">Identity Map</a>) and higher, it would not have any effect.
To make it workable the process P2 should be locked before the transaction had been beginning.</p>
<p>Thus, this solution would be partial, not universal, and would contain an uncontrolled dependence.
For 2 from 4 of transaction isolation level it would not work.</p>
</div>
<div class="section" id="accompanying-obstacle-to-implementing-pessimistic-locking">
<h2><a class="toc-backref" href="#id9">Accompanying obstacle to implementing pessimistic locking</a><a class="headerlink" href="#accompanying-obstacle-to-implementing-pessimistic-locking" title="Permalink to this headline">¶</a></h2>
<p>Except the constructive obstacle to implementing pessimistic locking, there is also some other obstacles.</p>
<p>The library is focused mainly on web applications.
Waiting for parallel process until the end of the transaction, or until the slave is updated, which in some cases can take 8 seconds or more, is practically not feasible in web applications.</p>
<p>There is the 3 main reasons:</p>
<ul class="simple">
<li>The quickness of response is important for web-application, otherwise a client simply could not wait for the response.</li>
<li>There is no any reason to wait for lock release longer than it takes time to create the cache itself.</li>
<li>Increase the number of pending processes could lead to the memory overflow, or reaching of available workers of the server, or reaching of the maximum allowed number of connections to the database or other resources.</li>
</ul>
<p>Also, there could be a problem with the implementation, since it is impossible to correctly block all tags by single query.</p>
<ul class="simple">
<li>At first, we have to use method <code class="docutils literal"><span class="pre">cache.add()</span></code> instead of <code class="docutils literal"><span class="pre">cache.set_many()</span></code> for locking, to ensure the atomicity of the existence check and cache creation.</li>
<li>Secondly, each tag should be locked by separate query, that increases the overhead.</li>
<li>Thirdly, the locking by single query per tag can lead to <a class="reference external" href="https://en.wikipedia.org/wiki/Deadlock">Deadlock</a>, the probability of which can be significantly reduced by topological sorting.</li>
</ul>
<p>We should also mention the possibility of <a class="reference external" href="https://www.postgresql.org/docs/9.5/static/explicit-locking.html">row-level locking by DB</a> using <a class="reference external" href="https://www.postgresql.org/docs/9.5/static/sql-select.html#SQL-FOR-UPDATE-SHARE">SELECT FOR UPDATE</a>. But it works only when both transactions use <a class="reference external" href="https://www.postgresql.org/docs/9.5/static/sql-select.html#SQL-FOR-UPDATE-SHARE">SELECT FOR UPDATE</a>, otherwise <a class="reference external" href="https://www.postgresql.org/docs/9.5/static/transaction-iso.html#XACT-READ-COMMITTED">it does not work</a>:</p>
<blockquote>
<div>When a transaction uses this isolation level, a SELECT query (without a FOR UPDATE/SHARE clause) sees only data committed before the query began; it never sees either uncommitted data or changes committed during query execution by concurrent transactions. In effect, a SELECT query sees a snapshot of the database as of the instant the query begins to run.</div></blockquote>
<p>But nobody uses cache of select for update (it doesn&#8217;t make sense to do it, and usually select for update is not used by web-applications because business transaction is used instead). Also, this approach is not able to solve the problem of replication.</p>
</div>
</div>
<div class="section" id="thundering-herd">
<span id="thundering-herd-en"></span><h1><a class="toc-backref" href="#id10">Thundering herd</a><a class="headerlink" href="#thundering-herd" title="Permalink to this headline">¶</a></h1>
<p>But what we can to do if cached logic is really resource intensive?</p>
<p>Dogpile is also known as <a class="reference external" href="http://en.wikipedia.org/wiki/Thundering_herd_problem">Thundering Herd</a> effect or cache stampede.</p>
<p>The answer is simple - Pessimistic Lock. But we have to lock the key of the cache (or group of related keys, see <a class="reference external" href="http://martinfowler.com/eaaCatalog/coarseGrainedLock.html">Coarse-Grained Lock</a>, especially when using aggregate queries) instead of tags.
It&#8217;s because of when the cache key is released, the cache must be guaranteed to be created (but tags has many-to-many relation to caches).</p>
<p>The lock must cover the entire code fragment from reading the cache to creating it.
And this responsibility is not related to invalidation.</p>
<p>There is a lot of libraries which solve the issue, for example:</p>
<ul class="simple">
<li><a class="reference external" href="https://bitbucket.org/akorn/wheezy.caching/src/586b4debff62f885d97e646f0aa2e5d22d088bcf/src/wheezy/caching/patterns.py?at=default&amp;fileviewer=file-view-default#patterns.py-348">wheezy.caching.patterns.OnePass</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/memcached_lock">memcached_lock</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/memcachelock">memcachelock</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/unimr.memcachedlock">unimr.memcachedlock</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/DistributedLock">DistributedLock</a></li>
<li><a class="reference external" href="https://chris-lamb.co.uk/posts/distributing-locking-python-and-redis">distributing-locking-python-and-redis</a></li>
<li><a class="reference external" href="https://github.com/mpessas/python-redis-lock/blob/master/redislock/lock.py">mpessas/python-redis-lock</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/pylock">pylock</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/python-redis-lock">python-redis-lock</a></li>
<li><a class="reference external" href="https://github.com/andymccurdy/redis-py/blob/master/redis/lock.py">redis-py</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/redlock">redlock</a></li>
<li><a class="reference external" href="https://github.com/bbangert/retools/blob/master/retools/lock.py">retools</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/score.distlock">score.distlock</a></li>
</ul>
</div>
<div class="section" id="transaction-problem">
<h1><a class="toc-backref" href="#id11">Transaction problem</a><a class="headerlink" href="#transaction-problem" title="Permalink to this headline">¶</a></h1>
<p>When traffic of web-application is high, the concurrent process can recreate the cache with outdated data since the tag has been invalidated but before the transaction is committed.
In contrast to replication problem, this problem depends on the quality of the ORM and can be reduced by using pattern <a class="reference external" href="http://martinfowler.com/eaaCatalog/unitOfWork.html">Unit of Work</a>.</p>
<p>Let to consider the problem for each <a class="reference external" href="https://en.wikipedia.org/wiki/Isolation_(database_systems)">transaction isolation level</a> separately.</p>
<div class="section" id="read-uncommitted">
<h2><a class="toc-backref" href="#id12">Read uncommitted</a><a class="headerlink" href="#read-uncommitted" title="Permalink to this headline">¶</a></h2>
<p>This is a simple case without any problems. If replication is used, it&#8217;s enough to repeat invalidation when the slave is guaranteed to be updated.</p>
</div>
<div class="section" id="read-committed">
<h2><a class="toc-backref" href="#id13">Read committed</a><a class="headerlink" href="#read-committed" title="Permalink to this headline">¶</a></h2>
<p>There is a problem, especially when you use the pattern <a class="reference external" href="http://www.martinfowler.com/eaaCatalog/activeRecord.html">ActiveRecord</a>.
The probability of the problem can be reduced by using the pattern <a class="reference external" href="http://martinfowler.com/eaaCatalog/dataMapper.html">DataMapper</a> together with <a class="reference external" href="http://martinfowler.com/eaaCatalog/unitOfWork.html">Unit of Work</a> to reduce the interval of time between data saving and transaction commit.
But the problem is still possible.</p>
<p>In contrast to the replication problem, it would be preferable to use tag locking here until the transaction will be committed, because the current process reads different data than concurrent processes.
It&#8217;s impossible to say which process (the current process or concurrent one) will have created the cache, thus it would be desirable to avoid cache creation until transaction is committed.</p>
<p>But this transaction isolation level is not so serious, and most often used to increase the degree of parallelism, i.e. has the same purpose as replication.
In this case, the problem of the transaction isolation level &#8220;Read committed&#8221; is usually absorbed by the replication problem, because process usually reads data from a slave.</p>
<p>Therefore, the expensive lock can be replaced by a re-invalidation when transaction is committed, as tradeoff.</p>
</div>
<div class="section" id="repeatable-read">
<h2><a class="toc-backref" href="#id14">Repeatable read</a><a class="headerlink" href="#repeatable-read" title="Permalink to this headline">¶</a></h2>
<p>This case is more interesting.
We can&#8217;t avoid tag locking here because we have to know not only the list of cache&#8217;s tags, but also the time of each transaction commit which has invalidated the tag.</p>
<p>Thus, we have to lock the tag from the moment of the invalidation, but, moreover, we are not able to create cache in transactions which has been begun earlier than the current transaction is committed.</p>
<p>The good news is that we can lock the tag until the slave will be updated, if we have to use tag locking in any case.</p>
</div>
<div class="section" id="serializable">
<h2><a class="toc-backref" href="#id15">Serializable</a><a class="headerlink" href="#serializable" title="Permalink to this headline">¶</a></h2>
<p>Because non-existent objects usually are not cached, we are able to limit the problem of this transaction isolation level by the level of <a class="reference internal" href="#repeatable-read">Repeatable read</a>.</p>
</div>
</div>
<div class="section" id="multiple-connections-to-database">
<h1><a class="toc-backref" href="#id16">Multiple connections to Database</a><a class="headerlink" href="#multiple-connections-to-database" title="Permalink to this headline">¶</a></h1>
<p>When you use multiple databases, and their transactions are synchronous, or you use simple replication, then you can use one instance of outer cache (wrapper) per one instance of inner cache (backend).
The transaction of the cache does not have to strictly follow to system transactions of the DB.
It is enough to fulfill its purpose - to prevent the substitution of the actual data in the cache by the concurrent process until the actual data will be visible for the concurrent process.
Therefore, a single transaction of the cache can cover several system database transactions.</p>
<p>When you use multiple connections to the same database (it sounds a little strange, but theoretically it&#8217;s possible, for example, when you don&#8217;t have ability to share connection between several ORMs in the single application), or the system database transactions are not synchronous, then you can configure the outer cache (wrapper) in the way to have one instance of outer cache (wrapper) per one connection to DB for each instance of inner cache (backend).</p>
</div>
<div class="section" id="non-cached-fragment-dynamic-window-in-cache">
<h1><a class="toc-backref" href="#id17">Non-cached fragment. Dynamic window in cache.</a><a class="headerlink" href="#non-cached-fragment-dynamic-window-in-cache" title="Permalink to this headline">¶</a></h1>
<p>There are two mutually complementary patterns based on diametrically opposite principles - <a class="reference external" href="https://en.wikipedia.org/wiki/Decorator_pattern">Decorator</a> и <a class="reference external" href="https://en.wikipedia.org/wiki/Strategy_pattern">Strategy</a>.
In the first case, the variable logic is placed around the declared code, in the second case it is passed into it.
Usual cache is similar to the pattern <a class="reference external" href="https://en.wikipedia.org/wiki/Decorator_pattern">Decorator</a>, when the dynamic logic is located around the cached logic.
But sometimes a little fragment of the logic should not to be cached inside the cache.
For example, it can be some data of user, a personal menu, a permission checking etc.</p>
<p>This problem can be solved by using <a class="reference external" href="https://en.wikipedia.org/wiki/Server_Side_Includes">Server Side Includes</a>.</p>
<p>Another approach is to use two-phase template rendering, for example <a class="reference external" href="https://pypi.python.org/pypi/django-phased">django-phased</a>.
To be honest, this approach has a considerable resource consumption, and in some cases the achieved effect can be gone.
Probably, due to this reason the approach is not widely used.</p>
<p>The popular template engine Smarty written by PHP has the function <a class="reference external" href="http://www.smarty.net/docs/en/language.function.nocache.tpl">{nocache}</a>.</p>
<p>But the more interesting approach would be to use python code inside the dynamic window to abstract from third-party technologies.</p>
<div class="note update admonition">
<p class="first admonition-title">Updated on Nov 06, 2016</p>
<p class="last">Added abstract dependency manager.</p>
</div>
</div>
<div class="section" id="abstract-dependency-manager">
<h1><a class="toc-backref" href="#id18">Abstract dependency manager</a><a class="headerlink" href="#abstract-dependency-manager" title="Permalink to this headline">¶</a></h1>
<p>For a long time I did not like the fact that several classes with different responsibilities were aware about the logic of tags handling.</p>
<p>It would be good to encapsulate this logic into separate <a class="reference external" href="https://en.wikipedia.org/wiki/Strategy_pattern">class strategy</a>, for example, similar to <a class="reference external" href="http://www.yiiframework.com/doc-2.0/yii-caching-tagdependency.html">TagDependency of YII framework</a>,
but this approach creates overhead as <a class="reference external" href="https://github.com/yiisoft/yii2/blob/32f4dc8997500f05ac3f62f0505c0170d7e58aed/framework/caching/Cache.php#L187">extra query per each cache key to verify its tags</a>, that means depriving the method <code class="docutils literal"><span class="pre">cache.get_many()</span></code> of the sense of aggregation queries.
I think, the overhead should not be more than one extra query per action, even where this action is aggregation like <code class="docutils literal"><span class="pre">cache.get_many()</span></code>.</p>
<p>Also I had another method with tangled responsibilities to provide aggregation queries, that does not cause delight.</p>
<p>But I like the idea to extract an abstract dependency manager, and obtain ability to use not only tags for invalidation, but any another principle, even an composite principle.</p>
<p>The problem had been solved by class <a class="reference external" href="https://bitbucket.org/emacsway/cache-dependencies/src/default/cache_dependencies/defer.py">Deferred</a>.
It&#8217;s not pure Deferred as we know it from asynchronous programming, otherwise I would like to use this <a class="reference external" href="https://pypi.python.org/pypi/defer">elegant and lightweight library</a>, kindly provided by the guys from Canonical.</p>
<p>My case requires not only delay the query execution, but also aggregation queries when it possible, for example, by using of <code class="docutils literal"><span class="pre">cache.get_many()</span></code>.</p>
<p>Probably, the name Queue or Aggregator would be better, but since from the interface point of view we just postpone the task execution without going into details of its implementation, I preferred to leave the name Deferred.</p>
<p>This approach allows me to extract the abstract dependency manager, and now the logic of invalidation by cache tagging is a simple implementation of the intarface as class strategy <a class="reference external" href="https://bitbucket.org/emacsway/cache-dependencies/src/default/cache_dependencies/dependencies.py">TagsDependency</a>.</p>
<p>This opens prospects for the creation of other implementations of dependency management, for example, by observing a file changing, or SQL query, or some system events.</p>
</div>
<div class="section" id="gratitude">
<h1><a class="toc-backref" href="#id19">Gratitude</a><a class="headerlink" href="#gratitude" title="Permalink to this headline">¶</a></h1>
<p>Thanks a lot to <a class="reference external" href="https://bitbucket.org/akorn">&#64;akorn</a> for the meaningful discussion of the problem of caching.</p>
<p>Эта статья на Русском языке &#8220;<a class="reference internal" href="../../ru/cache-dependencies/"><span class="doc">О проблемах инвалидации кэша. Тегирование кэша.</span></a>&#8221;.</p>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  
  <a href="../../ru/build-raw-sql-by-storm-orm/">
    <i class="fa fa-arrow-circle-left"></i>
    Построение Raw-SQL cредствами Storm-ORM
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  
  <a href="../../ru/cache-dependencies/">
    О проблемах инвалидации кэша. Тегирование кэша.
    <i class="fa fa-arrow-circle-right"></i>
  </a>
  </span>
  
</div>

  
  
    <div class="section">
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'emacsway';
        var disqus_identifier = '/en/cache-dependencies/';
        var disqus_title = 'About problems of cache invalidation. Cache tagging.';
        var disqus_url = 'https://emacsway.github.io/en/cache-dependencies/';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  
  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../">
    <img class="logo" src="../../_static/logo.jpg" alt="Logo"/>
    
    <h1 class="logo logo-name">@emacsway's blog</h1>
    
  </a>
</p>









  
  
  <h2>
  
  <i class="fa fa-calendar"></i>
    May 21, 2016
  
  </h2>

  <ul>
    
  <li><i class="fa fa-pencil-square-o"></i>
    Nov 10, 2016</li>
  

  
  <li><i class="fa-fw fa fa-user"></i>
    
      
      <a href="../../blog/author/ivan-zakrevsky/">Ivan Zakrevsky</a>
      
    </li>
  

  

  
  <li><i class="fa-fw fa fa-language"></i>
    
      
      <a href="../../blog/language/english/">English</a>
      
    </li>
  

  

  
  <li><i class="fa-fw fa fa-tag"></i>
    
      
      <a href="../../blog/tag/cache/">cache</a>
      
    </li>
  
  
  <li>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'emacsway'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    <i class="fa-fw fa fa-comments"></i>
    <a href="#disqus_thread" data-disqus-identifier="/en/cache-dependencies/"> </a>
  </li>
  
  </ul>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../about/">About me</a></li>
</ul>


<ul>
    
    <li class="toctree-l1"><a href="https://t.me/emacsway_log"><i class="fab fa-telegram"></i> Telegram</a></li>
    
</ul>

  <h3><a href="../../blog/">Recent Posts</a></h3>
  <ul>
    
    
      <li><a href="../../ru/message-ordering-in-competing-consumers/">Mar 31 - О гонке сообщений в условиях конкурирующих подписчиков</a></li>
    
      <li><a href="../../ru/domain-events-in-ddd/">May 05 - Domain Events in DDD</a></li>
    
      <li><a href="../../ru/self-learning-for-software-engineer/">Oct 11 - Список литературы для самообучения разработчика программного обеспечения</a></li>
    
      <li><a href="../../ru/tdd/">Sep 30 - TDD - Разработка через тестирование</a></li>
    
      <li><a href="../../ru/role-of-service-layer-in-cqrs-and-event-sourcing-using-redux-in-angular-as-an-example/">Sep 16 - Роль сервисного слоя в CQRS и Event Sourcing на примере использования Redux в Angular</a></li>
    
  </ul>

  <h3><a href="../../blog/tag/">Tags</a></h3>
  <style type="text/css">
    ul.ablog-cloud {list-style: none; overflow: auto;}
    ul.ablog-cloud li {float: left; height: 20pt; line-height: 18pt; margin-right: 5px;}
    ul.ablog-cloud a {text-decoration: none; vertical-align: middle;}
    li.ablog-cloud-1{font-size: 80%;}
    li.ablog-cloud-2{font-size: 95%;}
    li.ablog-cloud-3{font-size: 110%;}
    li.ablog-cloud-4{font-size: 125%;}
    li.ablog-cloud-5{font-size: 140%;}
  </style>
  <ul class="ablog-cloud">
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/agile/">Agile</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/angular/">Angular</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="../../blog/tag/architecture/">Architecture</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/cqrs/">CQRS</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/clean-code/">Clean Code</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="../../blog/tag/db/">DB</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="../../blog/tag/ddd/">DDD</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="../../blog/tag/datamapper/">DataMapper</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/dependency-injection/">Dependency Injection</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/design/">Design</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/distributed-systems/">Distributed Systems</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/django/">Django</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="../../blog/tag/django-model/">Django Model</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/docker/">Docker</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/eip/">EIP</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/emacs/">Emacs</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/event-sourcing/">Event Sourcing</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/extreme-programming/">Extreme Programming</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/flux/">Flux</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/fowler/">Fowler</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/hr/">HR</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/hiring/">Hiring</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/javascript/">JavaScript</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/microservices/">Microservices</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-4">
        <a href="../../blog/tag/model/">Model</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-5">
        <a href="../../blog/tag/orm/">ORM</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-4">
        <a href="../../blog/tag/python/">Python</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/redux/">Redux</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="../../blog/tag/refactoring/">Refactoring</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/repository/">Repository</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="../../blog/tag/sql/">SQL</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/scrum/">Scrum</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/service-layer/">Service Layer</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/storm-orm/">Storm ORM</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/tdd/">TDD</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/xp/">XP</a></li>
      
    
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/autocomplete/">autocomplete</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/cache/">cache</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/programming/">programming</a></li>
      
    
  </ul>

  <h3><a href="../../blog/category/">Categories</a></h3>
  <ul>
  
    
    <li><a href="../../blog/category/architecture/">Architecture (1)</a></li>
    
  
    
    <li><a href="../../blog/category/cqrs/">CQRS (1)</a></li>
    
  
    
    <li><a href="../../blog/category/clean-architecture/">Clean Architecture (1)</a></li>
    
  
    
    <li><a href="../../blog/category/clean-code/">Clean Code (1)</a></li>
    
  
    
    <li><a href="../../blog/category/ddd/">DDD (1)</a></li>
    
  
    
    <li><a href="../../blog/category/event-sourcing/">Event Sourcing (1)</a></li>
    
  
    
    <li><a href="../../blog/category/event-driven/">Event-Driven (1)</a></li>
    
  
    
    <li><a href="../../blog/category/extreme-programming/">Extreme Programming (1)</a></li>
    
  
    
    <li><a href="../../blog/category/microservices/">Microservices (1)</a></li>
    
  
    
    <li><a href="../../blog/category/refactoring/">Refactoring (1)</a></li>
    
  
    
    <li><a href="../../blog/category/tdd/">TDD (1)</a></li>
    
  
    
    <li><a href="../../blog/category/xp/">XP (1)</a></li>
    
  
    
    <li><a href="../../blog/category/programming/">programming (1)</a></li>
    
  
  </ul>

  <h3><a href="../../blog/archive/">Archives</a></h3>
  <ul>
  
    
    <li><a href="../../blog/2021/">2021 (1)</a></li>
    
  
    
    <li><a href="../../blog/2020/">2020 (1)</a></li>
    
  
    
    <li><a href="../../blog/2019/">2019 (2)</a></li>
    
  
    
    <li><a href="../../blog/2018/">2018 (4)</a></li>
    
  
    
    <li><a href="../../blog/2017/">2017 (9)</a></li>
    
  
    
    <li><a href="../../blog/2016/">2016 (5)</a></li>
    
  
    
    <li><a href="../../blog/2015/">2015 (6)</a></li>
    
  
  </ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer">
      &copy;2021, Ivan Zakrevskii.
      
      |
      Powered by <a href="http://ablog.readthedocs.org/">ABlog</a> &amp; <a href="http://sphinx-doc.org/">Sphinx 1.4.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
      |
      <a href="../../_sources/en/cache-dependencies.txt"
          rel="nofollow">Page source</a>
    </div>

    

    


    

        <!-- Go to www.addthis.com/dashboard to customize your tools -->
        <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-597ba7fb5af2ef1e"></script>

    


<!-- google.com/analytics counter -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69288289-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- /google.com/analytics counter -->


<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter32948409 = new Ya.Metrika({
                    id:32948409,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/32948409" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->



  </body>
</html>