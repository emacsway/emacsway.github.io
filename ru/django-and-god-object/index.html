<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="ru">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Django Framework и Божественный Объект &mdash; @emacsway&#39;s blog</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/fa/css/all.min.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="top" title="@emacsway&#39;s blog" href="../../" />
  

   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />


    

        <meta http-equiv="Last-Modified" content="Tue, 02 Jan 2018 00:00:00 GMT" />
        
            <meta name="description" content="Божественные Объекты - распространенное явление для Django приложений, поэтому рассмотрим этот вопрос более детально." />
        
        
            <meta property="og:image" content="../../_static/logo.jpg" />
            <link rel="image_src" href="../../_static/logo.jpg" />
        

        <link rel="canonical" href="https://emacsway.github.io/ru/django-and-god-object/" />

    


  
  <link rel="alternate" type="application/atom+xml"  href="../../blog/atom.xml" title="@emacsway's blog">
  
  
  <link href="True" rel="stylesheet">
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="django-framework">
<h1><a class="toc-backref" href="#id21">Django Framework и Божественный Объект</a><a class="headerlink" href="#django-framework" title="Permalink to this headline">¶</a></h1>
<p>Божественные Объекты - распространенное явление для Django приложений, поэтому рассмотрим этот вопрос более детально.</p>
<div class="contents topic" id="id1">
<p class="topic-title first">Содержание</p>
<ul class="simple">
<li><a class="reference internal" href="#django-framework" id="id21">Django Framework и Божественный Объект</a></li>
<li><a class="reference internal" href="#magic-strings" id="id22">Волшебные строки (Magic Strings)</a></li>
<li><a class="reference internal" href="#god-object" id="id23">Божественный Объект (God Object)</a><ul>
<li><a class="reference internal" href="#id2" id="id24">Проблема с тестированием</a></li>
<li><a class="reference internal" href="#id3" id="id25">Брешь в инкапсуляции</a></li>
<li><a class="reference internal" href="#code-smell-feature-envy" id="id26">&#8220;Завистливые функции&#8221; (Code Smell &#8220;Feature Envy&#8221;)</a></li>
<li><a class="reference internal" href="#high-coupling" id="id27">Повышенное сопряжение (High Coupling)</a></li>
<li><a class="reference internal" href="#id7" id="id28">Решение</a></li>
</ul>
</li>
<li><a class="reference internal" href="#code-smell-switch-statements" id="id29">Code Smell &#8220;Switch Statements&#8221;</a><ul>
<li><a class="reference internal" href="#id13" id="id30">Простое решение</a></li>
<li><a class="reference internal" href="#id15" id="id31">Чистое решение</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id18" id="id32">Чистая архитектура</a></li>
<li><a class="reference internal" href="#id20" id="id33">Вывод</a></li>
</ul>
</div>
<p>Здесь уместно упомянуть, что эту проблему уже озвучивал всем известный Андрей Светлов в статье &#8220;<a class="reference external" href="http://asvetlov.blogspot.com/2015/05/global-config.html">Почему я не люблю конфигурацию в django-style</a>&#8221;. Поэтому, я просто углублюсь в эту тему.</p>
<p>В качестве примера выдумаем простейший пример для выдачи файла robots.txt с различным содержимым в зависимости от окружения (staging или production). Будем считать, что ограничить доступ к staging-сайту мы по каким-то причинам не можем, а вариант использования статического сервера не предоставляется облачным сервисом.</p>
<p>Я часто наблюдаю в Django-приложениях нечто подобное:</p>
<div class="literal-block-wrapper container" id="someproject-settings-production-py-v1">
<div class="code-block-caption"><span class="caption-text">someproject/settings_production.py</span><a class="headerlink" href="#someproject-settings-production-py-v1" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="s1">&#39;production&#39;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper container" id="robots-urls-py-v1">
<div class="code-block-caption"><span class="caption-text">robots/urls.py</span><a class="headerlink" href="#robots-urls-py-v1" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">robots.views</span> <span class="kn">import</span> <span class="n">RobotsTxtView</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;robots.txt&#39;</span><span class="p">,</span> <span class="n">RobotsTxtView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;text/plain&quot;</span>
    <span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;robots.txt&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper container" id="robots-views-py-v1">
<div class="code-block-caption"><span class="caption-text">robots/views.py</span><a class="headerlink" href="#robots-views-py-v1" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">TemplateView</span>


<span class="k">class</span> <span class="nc">RobotsTxtView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_template_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENVIRONMENT</span> <span class="o">==</span> <span class="s1">&#39;producton&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;robots.production.txt&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;robots.default.txt&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Знакомая картина, не правда ли?</p>
</div>
<div class="section" id="magic-strings">
<h1><a class="toc-backref" href="#id22">Волшебные строки (Magic Strings)</a><a class="headerlink" href="#magic-strings" title="Permalink to this headline">¶</a></h1>
<p>Вопрос: а Вы заметили опечатку в строке 7 файла <a class="reference internal" href="#robots-views-py-v1"><span class="std std-ref">robots/views.py</span></a>?
Одна такая опечатка чревата выпадением проекта из поискового индекса, что для многих проектов равносильно катастрофе.</p>
<p>Для решения этой проблемы, заменим волшебные строки константами.
Здесь нам пригодится тип данных <a class="reference external" href="https://docs.python.org/3/library/enum.html">Enum</a>.</p>
<p>На первый взгляд, мы могли бы перечислить допустимые значения окружений в файле с настройками проекта.
Но проблема в том, что приложение (application) не может зависеть от конкретного проекта (project).</p>
<p>Зато приложение может зависеть от другого приложения, и объявить зависимости в установочном файле (setup.py) пакета (package).</p>
<p>Итак, создадим дополнительное приложение и назовем его environment.
Создадим в нем файл constants.py.</p>
<p>Здесь возникает вопрос по поводу соглашения именования.
Когда переменная является одновременно и именем класса, и константой, то какое именование предпочесть?
Мне больше нравится второй вариант.</p>
<div class="literal-block-wrapper container" id="someproject-settings-production-py-v2">
<div class="code-block-caption"><span class="caption-text">someproject/settings_production.py</span><a class="headerlink" href="#someproject-settings-production-py-v2" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.settings</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">environment.constants</span> <span class="kn">import</span> <span class="n">AVAILABLE_ENVIRONMENT</span>

<span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">AVAILABLE_ENVIRONMENT</span><span class="o">.</span><span class="n">PRODUCTION</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper container" id="environment-constants-py-v2">
<div class="code-block-caption"><span class="caption-text">environment/constants.py</span><a class="headerlink" href="#environment-constants-py-v2" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">IntEnum</span><span class="p">,</span> <span class="n">unique</span>


<span class="nd">@unique</span>
<span class="k">class</span> <span class="nc">AVAILABLE_ENVIRONMENT</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">LOCAL</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">DEVELOPMENT</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">STAGING</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">PRODUCTION</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">AVAILABLE_ENVIRONMENT</span><span class="o">.</span><span class="n">do_not_call_in_templates</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper container" id="robots-views-py-v2">
<div class="code-block-caption"><span class="caption-text">robots/views.py</span><a class="headerlink" href="#robots-views-py-v2" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">TemplateView</span>
<span class="kn">from</span> <span class="nn">environment.constants</span> <span class="kn">import</span> <span class="n">AVAILABLE_ENVIRONMENT</span>


<span class="k">class</span> <span class="nc">RobotsTxtView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_template_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENVIRONMENT</span> <span class="o">==</span> <span class="n">AVAILABLE_ENVIRONMENT</span><span class="o">.</span><span class="n">PRODUCTION</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;robots.production.txt&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;robots.default.txt&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="god-object">
<h1><a class="toc-backref" href="#id23">Божественный Объект (God Object)</a><a class="headerlink" href="#god-object" title="Permalink to this headline">¶</a></h1>
<p>Ок, мы застраховались от случайной опечатки.
Следующая проблема имеет название &#8220;Божественный Объект&#8221; (&#8220;<a class="reference external" href="https://en.wikipedia.org/wiki/God_object">God Object</a> или  &#8220;<a class="reference external" href="http://wiki.c2.com/?GodClass">God Class</a>&#8221;).</p>
<div class="section" id="id2">
<h2><a class="toc-backref" href="#id24">Проблема с тестированием</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>Как нам убедиться в том, что этот класс будет работать во всех окружениях?
Что если мы забыли загрузить какой-то templatetag в шаблоне <code class="docutils literal"><span class="pre">robots.production.txt</span></code>?
Итак, мы должны протестировать класс RobotsTxtView для всех окружений, в том числе и для PRODUCTION-окружения, при этом находясь реально в LOCAL-окружении.</p>
<p>Но как нам протестировать этот класс для всех окружений, не изменяя реального окружения?
Если я переопределю значение settings.ENVIRONMENT согласно документации, используя <a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/testing/tools/#django.test.override_settings">&#64;override_settings(ENVIRONMENT=AVAILABLE_ENVIRONMENT.PRODUCTION)</a>, то где гарантия, что я не изменю поведение какой-нибудь Middleware, использующей этот же конфигурационный параметр?</p>
<p>Да, в Django Framework есть небольшие трудности с изолированными юнит-тестами, которые решаются принципами &#8220;Чистой Архитектуры&#8221;, к этому вопросу мы еще вернемся чуть позже.
А пока нам нужно подменить значение окружения для класса, и при этом не затронуть его для всех остальных компонентов сайта.</p>
</div>
<div class="section" id="id3">
<h2><a class="toc-backref" href="#id25">Брешь в инкапсуляции</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>Проблема обращения метода к глобальной переменной заключается в том, что она образует брешь в инкапсуляции.
А инкапсуляция создана для защиты абстракции, которая, в свою очередь, создана для укрощения сложности.</p>
<p>Нарушив инкапсуляцию всего одной глобальной переменной, мы уже больше не можем рассматривать отдельно взятый метод.
Мы должны, вместе с этим методом, так же осознать все обращения к этой глобальной переменной по всей программе.
Декомпозиция сложности нарушена. Ее последствия я уже рассматривал в статье &#8220;<a class="reference internal" href="../../en/how-to-quickly-develop-high-quality-code/"><span class="doc">How to quickly develop high-quality code. Team work.</span></a>&#8221;.
А пока просто напомню, что рост сложности программы снижает темпы ее разработки, и делает разработку программы дорогой (обычно в экспоненциальной зависимости).</p>
</div>
<div class="section" id="code-smell-feature-envy">
<h2><a class="toc-backref" href="#id26">&#8220;Завистливые функции&#8221; (Code Smell &#8220;Feature Envy&#8221;)</a><a class="headerlink" href="#code-smell-feature-envy" title="Permalink to this headline">¶</a></h2>
<p>Вы заметили, что наш класс RobotsTxtView интересуется данным другого класса (django.conf.Settings)?</p>
<blockquote>
<div><p>Завистливые функции</p>
<p>Весь смысл объектов в том, что они позволяют хранить данные вместе
с процедурами их обработки. Классический пример дурного запаха -
метод, который больше интересуется не тем классом, в котором он
находится, а каким-то другим. Чаще всего предметом зависти являются
данные.</p>
<p>Feature Envy</p>
<p>The whole point of objects is that they are a technique to package data with the processes used
on that data. A classic smell is a method that seems more interested in a class other than the one
it actually is in. The most common focus of the envy is the data.</p>
<p>(&#8220;Refactoring: Improving the Design of Existing Code&#8221; <a class="footnote-reference" href="#fnrefactoring" id="id4">[2]</a> by Martin Fowler, Kent Beck, John Brant, William Opdyke, Don Roberts)</p>
</div></blockquote>
</div>
<div class="section" id="high-coupling">
<h2><a class="toc-backref" href="#id27">Повышенное сопряжение (High Coupling)</a><a class="headerlink" href="#high-coupling" title="Permalink to this headline">¶</a></h2>
<p>Вы заметили, что класс RobotsTxtView должен быть осведомленным об интерфейсе (либо структуре) объекта settings?</p>
<p>Хорошая программа обладает &#8220;Низким Сопряжением (Зацеплением) и Высокой Связанностью&#8221; (&#8220;<a class="reference external" href="http://wiki.c2.com/?CouplingAndCohesion">Low coupling &amp; High cohesion</a>&#8221;).</p>
<p>Существуют Push и Pull модели данных.
В первом случае приложение должно установить зависимости в объект.
Во втором случае, объект должен запросить зависимости у приложения.</p>
<p>Проблема в том, что для того, чтобы запросить, объект должен быть осведомлен об интерфейсе, по которому он может это сделать.
А это - лишнее Сопряжение (Coupling), которое снижает повторную используемость класса.
Что если Вы захотите использовать этот класс в другом приложении, которое имеет другой интерфейс для запросов?</p>
<p>В этом и заключается превосходство &#8220;Пассивного Внедрения Зависимостей&#8221; (&#8220;Passive Dependency Injection&#8221;) <a class="footnote-reference" href="#fnccode" id="id5">[1]</a> над &#8220;Локатором Служб&#8221; (&#8220;Service Locator&#8221;), смотрите более подробно в статье &#8220;<a class="reference external" href="https://martinfowler.com/articles/injection.html">Inversion of Control Containers and the Dependency Injection pattern</a>&#8221; by Martin Fowler.</p>
<blockquote>
<div><p>Истинное внедрение зависимостей идет еще на один шаг вперед. Класс не
предпринимает непосредственных действий по разрешению своих зависимостей;
он остается абсолютно пассивным. Вместо этого он предоставляет set-методы
и/или аргументы конструктора, используемые для внедрения зависимостей.
В процессе конструирования контейнер DI создает экземпляры необходимых
объектов (обычно по требованию) и использует аргументы конструктора или
set-методы для скрепления зависимостей. Фактически используемые
зависимые объекты задаются в конфигурационном файле или на программном уровне
в специализированном конструирующем модуле.</p>
<p>True Dependency Injection goes one step further. The class takes no direct steps to
resolve its dependencies; it is completely passive. Instead, it provides setter methods or
constructor arguments (or both) that are used to inject the dependencies. During the con-
struction process, the DI container instantiates the required objects (usually on demand)
and uses the constructor arguments or setter methods provided to wire together the depen-
dencies. Which dependent objects are actually used is specified through a configuration
file or programmatically in a special-purpose construction module.</p>
<p>(&#8220;Clean Code: A Handbook of Agile Software Craftsmanship&#8221; <a class="footnote-reference" href="#fnccode" id="id6">[1]</a>)</p>
</div></blockquote>
</div>
<div class="section" id="id7">
<h2><a class="toc-backref" href="#id28">Решение</a><a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<p>Самый простой способ локализовать эту настройку - это параметризация объекта при помощи конструктора.</p>
<div class="literal-block-wrapper container" id="robots-urls-py-v3">
<div class="code-block-caption"><span class="caption-text">robots/urls.py</span><a class="headerlink" href="#robots-urls-py-v3" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">robots.views</span> <span class="kn">import</span> <span class="n">RobotsTxtView</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;robots.txt&#39;</span><span class="p">,</span> <span class="n">RobotsTxtView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
        <span class="n">environment</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ENVIRONMENT</span>
    <span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;robots.txt&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper container" id="robots-views-py-v3">
<div class="code-block-caption"><span class="caption-text">robots/views.py</span><a class="headerlink" href="#robots-views-py-v3" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">TemplateView</span>
<span class="kn">from</span> <span class="nn">environment.constants</span> <span class="kn">import</span> <span class="n">AVAILABLE_ENVIRONMENT</span>


<span class="k">class</span> <span class="nc">RobotsTxtView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="n">AVAILABLE_ENVIRONMENT</span> <span class="o">=</span> <span class="n">AVAILABLE_ENVIRONMENT</span>
    <span class="n">environment</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_template_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVAILABLE_ENVIRONMENT</span><span class="o">.</span><span class="n">PRODUCTION</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;robots.production.txt&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;robots.default.txt&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Я так же разместил константу AVAILABLE_ENVIRONMENT в пространстве имен класса, чтобы на нее распространялась концепция наследования.</p>
</div>
</div>
<div class="section" id="code-smell-switch-statements">
<h1><a class="toc-backref" href="#id29">Code Smell &#8220;Switch Statements&#8221;</a><a class="headerlink" href="#code-smell-switch-statements" title="Permalink to this headline">¶</a></h1>
<p>Как уже отмечалось ранее, &#8220;Весь смысл объектов в том, что они позволяют хранить данные вместе с процедурами их обработки.&#8221; (&#8220;Refactoring: Improving the Design of Existing Code&#8221; <a class="footnote-reference" href="#fnrefactoring" id="id8">[2]</a>).
Объект должен обладать свойственным ему поведением, иначе весь смысл существования объектов теряется, а парадигма программирования превращается из объектно-ориентированной в процедурную.</p>
<p>Чтобы сохранить смысл объектов, условные операторы должны не управлять поведением объекта, а создавать объект с нужным поведением.
Т.е. они должны использоваться в Абстрактной Фабрике, Фабричном Методе, или просто в конструкторе объекта.</p>
<blockquote>
<div><p>Операторы типа switch</p>
<p>Одним из очевидных признаков объектно-ориентированного кода служит сравнительная
немногочисленность операторов типа switch (или case). Проблема, обусловленная применением switch, по
существу, связана с дублированием. Часто один и тот же блок switch оказывается разбросанным по разным
местам программы. При добавлении в переключатель нового варианта приходится искать все эти блоки switch
и модифицировать их. Понятие полиморфизма в ООП предоставляет элегантный способ справиться с этой
проблемой.</p>
<p>Как правило, заметив блок switch, следует подумать о полиморфизме. Задача состоит в том, чтобы
определить, где должен происходить полиморфизм. Часто переключатель работает в зависимости от кода типа.
Необходим метод или класс, хранящий значение кода типа. Поэтому воспользуйтесь «Выделением
метода» (Extract Method ) для выделения переключателя, а затем «Перемещением метода» (Move Method ) для
вставки его в тот класс, где требуется полиморфизм. В этот момент следует решить, чем воспользоваться-
«Заменой кода типа подклассами» (Replace Type Code with Subclasses ) или «Заменой кода типа
состоянием/стратегией» (Replace Type Code with State / Strategy ). Определив структуру наследования, можно
применить «Замену условного оператора полиморфизмом» (Replace Conditional with Polymorphism ).</p>
<p>Если есть лишь несколько вариантов переключателя, управляющих одним методом, и не предполагается
их изменение, то применение полиморфизма оказывается чрезмерным. В данном случае хорошим выбором
будет «Замена параметра явными методами» (Replace Parameter with Explicit Method ). Если одним из вариантов
является null, попробуйте прибегнуть к «Введению объекта Null» (Introduce Null Object ).</p>
<p>Switch Statements</p>
<p>One of the most obvious symptoms of object-oriented code is its comparative lack of switch (or
case) statements. The problem with switch statements is essentially that of duplication. Often you
find the same switch statement scattered about a program in different places. If you add a new
clause to the switch, you have to find all these switch, statements and change them. The
object-oriented notion of polymorphism gives you an elegant way to deal with this problem.</p>
<p>Most times you see a switch statement you should consider polymorphism. The issue is where
the polymorphism should occur. Often the switch statement switches on a type code. You want
the method or class that hosts the type code value. So use Extract Method to extract the switch
statement and then Move Method to get it onto the class where the polymorphism is needed. At
that point you have to decide whether to Replace Type Code with Subclasses or Replace
Type Code with State/Strategy. When you have set up the inheritance structure, you can use
Replace Conditional with Polymorphism.</p>
<p>If you only have a few cases that affect a single method, and you don&#8217;t expect them to change,
then polymorphism is overkill. In this case Replace Parameter with Explicit Methods is a
good option. If one of your conditional cases is a null, try Introduce Null Object.</p>
<p>(&#8220;Refactoring: Improving the Design of Existing Code&#8221; <a class="footnote-reference" href="#fnrefactoring" id="id9">[2]</a> by Martin Fowler, Kent Beck, John Brant, William Opdyke, Don Roberts)</p>
</div></blockquote>
<blockquote>
<div><p>G23: Используйте полиморфизм</p>
<p>Вместо if/Else или switch/Case
Я использую правило «ОДНОЙ КОМАНДЫ SWITCH»: для каждого типа
выбора программа не должна содержать более одной команды switch. Множественные
конструкции switch следует заменять полиморфными объектами.</p>
<p>G23: Prefer Polymorphism to If/Else or Switch/Case</p>
<p>I use the following “ONE SWITCH” rule: There may be no more than one switch
statement for a given type of selection. The cases in that switch statement must create
polymorphic objects that take the place of other such switch statements in the rest of the system.</p>
<p>(&#8220;Clean Code: A Handbook of Agile Software Craftsmanship&#8221; <a class="footnote-reference" href="#fnccode" id="id10">[1]</a> by Robert C. Martin)</p>
</div></blockquote>
<p>Вообще-то проблема не так и страшна, и с ней можно было бы и смириться по совету Мартина Фаулера.
Но мы пойдем дальше.</p>
<p>Есть два способа решить эту проблему, простой (&#8220;Replace Subclass with Fields&#8221;) <a class="footnote-reference" href="#fnrefactoring" id="id11">[2]</a> и чистый (&#8220;Replace Type Code with State/Strategy&#8221;) <a class="footnote-reference" href="#fnrefactoring" id="id12">[2]</a>.</p>
<div class="section" id="id13">
<h2><a class="toc-backref" href="#id30">Простое решение</a><a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<p>Если внимательно изучить класс <code class="docutils literal"><span class="pre">django.views.generic.base.TemplateView</span></code>, который наследует <a class="reference external" href="https://github.com/django/django/blob/2.0/django/views/generic/base.py#L132">django.views.generic.base.TemplateResponseMixin</a>, то можно заметить, что он реализует метод &#8220;<a class="reference external" href="https://www.refactoring.com/catalog/replaceSubclassWithFields.html">Replace Subclass with Fields</a>&#8221; <a class="footnote-reference" href="#fnrefactoring" id="id14">[2]</a>.
А потому, нет причин этим не воспользоваться.
Все что от нас требуется - это переместить условные операторы из метода объекта (т.е. его поведения) в его конструктор.</p>
<div class="literal-block-wrapper container" id="robots-views-py-v4">
<div class="code-block-caption"><span class="caption-text">robots/views.py</span><a class="headerlink" href="#robots-views-py-v4" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">TemplateView</span>
<span class="kn">from</span> <span class="nn">environment.constants</span> <span class="kn">import</span> <span class="n">AVAILABLE_ENVIRONMENT</span>


<span class="k">class</span> <span class="nc">RobotsTxtView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="n">AVAILABLE_ENVIRONMENT</span> <span class="o">=</span> <span class="n">AVAILABLE_ENVIRONMENT</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;robots.default.txt&#39;</span>
    <span class="n">environment</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;environment&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span>
        <span class="k">assert</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVAILABLE_ENVIRONMENT</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;environment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">AVAILABLE_ENVIRONMENT</span><span class="o">.</span><span class="n">PRODUCTION</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;robots.production.txt&#39;</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Атрибут класса RobotsTxtView.environment можно было бы удалить, если бы не <a class="reference external" href="https://github.com/django/django/blob/2.0/django/views/generic/base.py#L57">одно &#8220;но&#8221;</a>.</p>
</div>
<div class="section" id="id15">
<h2><a class="toc-backref" href="#id31">Чистое решение</a><a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h2>
<p>Чистое решение заключается в реализации метода &#8220;<a class="reference external" href="https://www.refactoring.com/catalog/replaceTypeCodeWithStateStrategy.html">Replace Type Code with State/Strategy</a>&#8221; <a class="footnote-reference" href="#fnrefactoring" id="id16">[2]</a>.</p>
<div class="literal-block-wrapper container" id="robots-views-py-v5">
<div class="code-block-caption"><span class="caption-text">robots/views.py</span><a class="headerlink" href="#robots-views-py-v5" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">collections.abc</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">TemplateView</span>


<span class="k">class</span> <span class="nc">DefaultTemplateNamesAccessor</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;robots.default.txt&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">ProductionTemplateNamesAccessor</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Callable</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;robots.production.txt&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">RobotsTxtView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="n">template_names_accessor</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s1">&#39;template_names_accessor&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_template_names</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;template_names_accessor&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper container" id="robots-factory-py-v5">
<div class="code-block-caption"><span class="caption-text">robots/factory.py</span><a class="headerlink" href="#robots-factory-py-v5" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">environment.constants</span> <span class="kn">import</span> <span class="n">AVAILABLE_ENVIRONMENT</span>
<span class="kn">from</span> <span class="nn">robots</span> <span class="kn">import</span> <span class="n">views</span>

<span class="k">class</span> <span class="nc">RobotsFactory</span><span class="p">:</span>
    <span class="n">AVAILABLE_ENVIRONMENT</span> <span class="o">=</span> <span class="n">AVAILABLE_ENVIRONMENT</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_robots_txt_view</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">environment</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">views</span><span class="o">.</span><span class="n">RobotsTxtView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
            <span class="n">template_names_accessor</span><span class="o">=</span><span class="n">cls</span><span class="o">.</span><span class="n">_make_template_names_accessor</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_make_template_names_accessor</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">environment</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">environment</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">AVAILABLE_ENVIRONMENT</span>
        <span class="k">if</span> <span class="n">environment</span> <span class="o">==</span> <span class="n">cls</span><span class="o">.</span><span class="n">AVAILABLE_ENVIRONMENT</span><span class="o">.</span><span class="n">PRODUCTION</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_make_production_template_names_accessor</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_make_default_template_names_accessor</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_default_template_names_accessor</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">views</span><span class="o">.</span><span class="n">DefaultTemplateNamesAccessor</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_production_template_names_accessor</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">views</span><span class="o">.</span><span class="n">ProductionTemplateNamesAccessor</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper container" id="robots-urls-py-v5">
<div class="code-block-caption"><span class="caption-text">robots/urls.py</span><a class="headerlink" href="#robots-urls-py-v5" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">robots.factory</span> <span class="kn">import</span> <span class="n">RobotsFactory</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;robots.txt&#39;</span><span class="p">,</span> <span class="n">RobotsFactory</span><span class="o">.</span><span class="n">make_robots_txt_view</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">ENVIRONMENT</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;robots.txt&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Как видите, чистое решение оказалось намного более многословным. Какое же решение предпочесть?</p>
<p>Лично я использую методику &#8220;Designing Through Refactoring&#8221; <a class="footnote-reference" href="#fnxp" id="id17">[3]</a>, и, в соответствии с принципом Экстремального Программирования &#8220;The simplest thing that could possibly work&#8221;, - всегда достигаю минимально-необходимого уровня косвенности (inderection).</p>
<p>Если решение простое, и оно работает (т.е. проходит тесты), и оно не содержит дубликатов, - то работа завершена.
Не должно быть принципов ради принципов.
Каждый принцип должен решать какую-то конкретную задачу. Если он ничего не решает, то он - лишний.</p>
<p>Не существует хороших или плохих решений.
Все дело - в достигаемом результате.
Задача Agile-методологии - поддерживать стоимость изменения программы низкой.
Если эта цель соблюдена - нет смысла усложнять дальше. Любое усложнение - это удорожание стоимости изменения программы.</p>
<p>Благодаря рефакторингу, всегда можно ввести необходимый уровень косвенности тогда, когда в этом возникнет необходимость. Самое главное - постоянно обеспечивать условия для облегчения рефакторинга (использовать Type Hinting для автоматизированных средств рефакторинга и т.п.).</p>
</div>
</div>
<div class="section" id="id18">
<h1><a class="toc-backref" href="#id32">Чистая архитектура</a><a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h1>
<p>Внимательный читатель может заметить что такой подход нарушает принципы &#8220;<a class="reference external" href="https://8thlight.com/blog/uncle-bob/2012/08/13/the-clean-architecture.html">Чистой Архитектуры</a>&#8221;.
Пример достижения чистой архитектуры Django приложений Вы можете посмотреть в статье &#8220;<a class="reference external" href="https://engineering.21buttons.com/clean-architecture-in-django-d326a4ab86a9">Clean Architecture in Django</a>&#8221;.</p>
<p>В данном случае, логика класса RobotsTxtView сильно вырождена для того, чтобы выделять из нее какой-нибудь Use Case.
Одно из основных назначений Use Case - упростить тестирование путем отделения его обязанности от обязанности Delivery Mechanism.</p>
<p>Конечно, Django Framework не позволяет так просто произвести изолированное тестирование класса RobotsTxtView, но предоставляет инструменты для того, чтобы тестирование (пусть и не изолированное) можно было сделать.</p>
<div class="literal-block-wrapper container" id="robots-tests-test-robots-py-v5">
<div class="code-block-caption"><span class="caption-text">robots/tests/test_robots.py</span><a class="headerlink" href="#robots-tests-test-robots-py-v5" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span><span class="p">,</span> <span class="n">override_settings</span>


<span class="k">class</span> <span class="nc">RobotsDefaultTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">ROOT_URLCONF</span><span class="o">=</span><span class="s1">&#39;robots.tests.robots_app.urls_default&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_robots_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/robots.txt&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;User-Agent&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;Host: https://myproject.com&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RobotsProductionTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">ROOT_URLCONF</span><span class="o">=</span><span class="s1">&#39;robots.tests.robots_app.urls_production&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_robots_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/robots.txt&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;User-Agent&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertContains</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;Host: https://myproject.com&quot;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper container" id="robots-tests-robots-app-urls-default-py-v5">
<div class="code-block-caption"><span class="caption-text">robots/tests/robots_app/urls_default.py</span><a class="headerlink" href="#robots-tests-robots-app-urls-default-py-v5" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">robots.views</span> <span class="kn">import</span> <span class="n">RobotsTxtView</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;robots.txt&#39;</span><span class="p">,</span> <span class="n">RobotsTxtView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
        <span class="n">environment</span><span class="o">=</span><span class="n">RobotsTxtView</span><span class="o">.</span><span class="n">AVAILABLE_ENVIRONMENT</span><span class="o">.</span><span class="n">STAGING</span>
    <span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;robots.txt&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="literal-block-wrapper container" id="robots-tests-robots-app-urls-production-py-v5">
<div class="code-block-caption"><span class="caption-text">robots/tests/robots_app/urls_production.py</span><a class="headerlink" href="#robots-tests-robots-app-urls-production-py-v5" title="Permalink to this code">¶</a></div>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">robots.views</span> <span class="kn">import</span> <span class="n">RobotsTxtView</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;robots.txt&#39;</span><span class="p">,</span> <span class="n">RobotsTxtView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
        <span class="n">environment</span><span class="o">=</span><span class="n">RobotsTxtView</span><span class="o">.</span><span class="n">AVAILABLE_ENVIRONMENT</span><span class="o">.</span><span class="n">PRODUCTION</span>
    <span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;robots.txt&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</td></tr></table></div>
</div>
<p>Другой проблемой является то, что мы лишены возможности подменить реализацию класса RobotsTxtView, поскольку не используем &#8220;Dependency Inversion Principle&#8221;.
Однако, такого же эффекта можно достигнуть и на уровне конфигурации URL-роутера.</p>
<p>Что касается вычленения Сервисного Слоя, то на этот вопрос ответил Martin Fowler:</p>
<blockquote>
<div><p>Гораздо легче ответить на вопрос, когда слой служб не нужно использовать. Скорее
всего, вам не понадобится слой служб, если у логики приложения есть только одна категория
клиентов, например пользовательский интерфейс, отклики которого на варианты
использования не охватывают несколько ресурсов транзакций. В этом случае управление
транзакциями и выбор откликов можно возложить на контроллеры страниц (Page
Controller, 350), которые будут обращаться непосредственно к слою источника данных.
Тем не менее, как только у вас появится вторая категория клиентов или начнет
использоваться второй ресурс транзакции, вам неизбежно придется ввести слой служб, что
потребует полной переработки приложения.</p>
<p>The easier question to answer is probably when not to use it. You probably don&#8217;t need a Service Layer if your
application&#8217;s business logic will only have one kind of client say, a user interface and its use case responses
don&#8217;t involve multiple transactional resources. In this case your Page Controllers can manually control
transactions and coordinate whatever response is required, perhaps delegating directly to the Data Source
layer.
But as soon as you envision a second kind of client, or a second transactional resource in use case responses, it
pays to design in a Service Layer from the beginning.</p>
<p>(«Patterns of Enterprise Application Architecture» <a class="footnote-reference" href="#fnpoeaa" id="id19">[4]</a> by Martin Fowler)</p>
</div></blockquote>
<p>Более подробна тема Сервисного Слоя освещена в статье &#8220;<a class="reference internal" href="../service-layer/"><span class="doc">Проектирование Сервисного Слоя и Логики Приложения</span></a>&#8221;.</p>
</div>
<div class="section" id="id20">
<h1><a class="toc-backref" href="#id33">Вывод</a><a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h1>
<p>Тот факт, что Божественные Объекты часто используются в Django приложениях, вовсе не обязывает Вас их использовать.
Чистота Вашего кода - только в Ваших руках.</p>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="fnccode" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[1]</td><td><em>(<a class="fn-backref" href="#id5">1</a>, <a class="fn-backref" href="#id6">2</a>, <a class="fn-backref" href="#id10">3</a>)</em> &#8220;<a class="reference external" href="http://www.informit.com/store/clean-code-a-handbook-of-agile-software-craftsmanship-9780132350884">Clean Code: A Handbook of Agile Software Craftsmanship</a>&#8221; by <a class="reference external" href="http://informit.com/martinseries">Robert C. Martin</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="fnrefactoring" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[2]</td><td><em>(<a class="fn-backref" href="#id4">1</a>, <a class="fn-backref" href="#id8">2</a>, <a class="fn-backref" href="#id9">3</a>, <a class="fn-backref" href="#id11">4</a>, <a class="fn-backref" href="#id12">5</a>, <a class="fn-backref" href="#id14">6</a>, <a class="fn-backref" href="#id16">7</a>)</em> &#8220;<a class="reference external" href="https://martinfowler.com/books/refactoring.html">Refactoring: Improving the Design of Existing Code</a>&#8221; by <a class="reference external" href="https://martinfowler.com/aboutMe.html">Martin Fowler</a>, Kent Beck, John Brant, William Opdyke, Don Roberts</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="fnxp" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id17">[3]</a></td><td>&#8220;<a class="reference external" href="http://www.informit.com/store/extreme-programming-explained-embrace-change-9780321278654">Extreme Programming Explained</a>&#8221; by Kent Beck</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="fnpoeaa" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id19">[4]</a></td><td>«<a class="reference external" href="https://www.martinfowler.com/books/eaa.html">Patterns of Enterprise Application Architecture</a>» by <a class="reference external" href="https://martinfowler.com/aboutMe.html">Martin Fowler</a>, David Rice, Matthew Foemmel, Edward Hieatt, Robert Mee, Randy Stafford</td></tr>
</tbody>
</table>
<div class="note update admonition">
<p class="first last admonition-title">Updated on Jan 02, 2018</p>
</div>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  
  <a href="../docker/">
    <i class="fa fa-arrow-circle-left"></i>
    Знакомство с Docker для Django-проекта
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  
  <a href="../anemic-domain-model/">
    Про Anemic Domain Model
    <i class="fa fa-arrow-circle-right"></i>
  </a>
  </span>
  
</div>

  
  
    <div class="section">
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'emacsway';
        var disqus_identifier = '/ru/django-and-god-object/';
        var disqus_title = 'Django Framework и Божественный Объект';
        var disqus_url = 'https://emacsway.github.io/ru/django-and-god-object/';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  
  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../">
    <img class="logo" src="../../_static/logo.jpg" alt="Logo"/>
    
    <h1 class="logo logo-name">@emacsway's blog</h1>
    
  </a>
</p>









  
  
  <h2>
  
  <i class="fa fa-calendar"></i>
    Jan 02, 2018
  
  </h2>

  <ul>
    

  
  <li><i class="fa-fw fa fa-user"></i>
    
      
      <a href="../../blog/author/ivan-zakrevsky/">Ivan Zakrevsky</a>
      
    </li>
  

  

  
  <li><i class="fa-fw fa fa-language"></i>
    
      
      <a href="../../blog/language/russian/">Russian</a>
      
    </li>
  

  

  
  <li><i class="fa-fw fa fa-tag"></i>
    
      
      <a href="../../blog/tag/django/">Django</a>
      
    </li>
  
  
  <li>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'emacsway'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    <i class="fa-fw fa fa-comments"></i>
    <a href="#disqus_thread" data-disqus-identifier="/ru/django-and-god-object/"> </a>
  </li>
  
  </ul>


<h3>Navigation</h3>
<ul class="simple">
</ul>


  <h3><a href="../../blog/">Recent Posts</a></h3>
  <ul>
    
    
      <li><a href="../it/agile/crash-course-in-software-development-economics/">May 05 - Краткий курс по экономике разработки программного обеспечения</a></li>
    
      <li><a href="../soft-skills/psychological-effects/">May 04 - Список психологических эффектов</a></li>
    
      <li><a href="../cqrs-command-and-result/">Apr 02 - Может ли CQRS-команда возвращать результат?</a></li>
    
      <li><a href="../message-ordering-in-competing-consumers/">Mar 31 - О гонке сообщений в условиях конкурирующих подписчиков</a></li>
    
      <li><a href="../domain-events-in-ddd/">May 05 - Domain Events in DDD</a></li>
    
  </ul>

  <h3><a href="../../blog/tag/">Tags</a></h3>
  <style type="text/css">
    ul.ablog-cloud {list-style: none; overflow: auto;}
    ul.ablog-cloud li {float: left; height: 20pt; line-height: 18pt; margin-right: 5px;}
    ul.ablog-cloud a {text-decoration: none; vertical-align: middle;}
    li.ablog-cloud-1{font-size: 80%;}
    li.ablog-cloud-2{font-size: 95%;}
    li.ablog-cloud-3{font-size: 110%;}
    li.ablog-cloud-4{font-size: 125%;}
    li.ablog-cloud-5{font-size: 140%;}
  </style>
  <ul class="ablog-cloud">
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/agile/">Agile</a></li>
      
    
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/angular/">Angular</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/autocomplete/">Autocomplete</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="../../blog/tag/cqrs/">CQRS</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/cqs/">CQS</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/cache/">Cache</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/career/">Career</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/clean-architecture/">Clean Architecture</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/clean-code/">Clean Code</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/communication/">Communication</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="../../blog/tag/db/">DB</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-4">
        <a href="../../blog/tag/ddd/">DDD</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="../../blog/tag/datamapper/">DataMapper</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/dependency-injection/">Dependency Injection</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/distributed-systems/">Distributed Systems</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/django/">Django</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="../../blog/tag/django-model/">Django Model</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/docker/">Docker</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/eip/">EIP</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/economics/">Economics</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/emacs/">Emacs</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="../../blog/tag/event-sourcing/">Event Sourcing</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/event-driven/">Event-Driven</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="../../blog/tag/extreme-programming/">Extreme Programming</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/flux/">Flux</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/fowler/">Fowler</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/functional-programming/">Functional Programming</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/hr/">HR</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/hiring/">Hiring</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/javascript/">JavaScript</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/management/">Management</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/microservices/">Microservices</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-4">
        <a href="../../blog/tag/model/">Model</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/oop/">OOP</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-5">
        <a href="../../blog/tag/orm/">ORM</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/programming/">Programming</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-4">
        <a href="../../blog/tag/python/">Python</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/redux/">Redux</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="../../blog/tag/refactoring/">Refactoring</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/repository/">Repository</a></li>
      
    
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="../../blog/tag/sql/">SQL</a></li>
      
    
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/scrum/">Scrum</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/service-layer/">Service Layer</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/soft-skills/">Soft Skills</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-4">
        <a href="../../blog/tag/software-architecture/">Software Architecture</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/software-construction/">Software Construction</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/software-design/">Software Design</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/storm-orm/">Storm ORM</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-1">
        <a href="../../blog/tag/tdd/">TDD</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-2">
        <a href="../../blog/tag/xp/">XP</a></li>
      
    
      
    
  </ul>

  <h3><a href="../../blog/archive/">Archives</a></h3>
  <ul>
  
    
    <li><a href="../../blog/2021/">2021 (4)</a></li>
    
  
    
    <li><a href="../../blog/2020/">2020 (1)</a></li>
    
  
    
    <li><a href="../../blog/2019/">2019 (2)</a></li>
    
  
    
    <li><a href="../../blog/2018/">2018 (4)</a></li>
    
  
    
    <li><a href="../../blog/2017/">2017 (9)</a></li>
    
  
    
    <li><a href="../../blog/2016/">2016 (5)</a></li>
    
  
    
    <li><a href="../../blog/2015/">2015 (6)</a></li>
    
  
  </ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer">
      &copy;2022, Ivan Zakrevsky.
      
      |
      Powered by <a href="http://ablog.readthedocs.org/">ABlog</a> &amp; <a href="http://sphinx-doc.org/">Sphinx 1.4.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
      |
      <a href="../../_sources/ru/django-and-god-object.txt"
          rel="nofollow">Page source</a>
    </div>

    

    


    

        <!-- Go to www.addthis.com/dashboard to customize your tools -->
        <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-597ba7fb5af2ef1e"></script>

    


<!-- google.com/analytics counter -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69288289-1', 'auto');
  ga('send', 'pageview');

</script>
<!-- /google.com/analytics counter -->


<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter32948409 = new Ya.Metrika({
                    id:32948409,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/32948409" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->



  </body>
</html>